```
     __                             ___            _             _ 
  ╱╲ ╲ ╲___  _ __ _ __ ___   ___   ╱ __╲___  _ __ │ │_ _ __ ___ │ │
 ╱  ╲╱ ╱ _ ╲│ '__│ '_ ` _ ╲ ╱ _ ╲ ╱ ╱  ╱ _ ╲│ '_ ╲│ __│ '__╱ _ ╲│ │
╱ ╱╲  ╱ (_) │ │  │ │ │ │ │ │ (_) ╱ ╱__│ (_) │ │ │ │ │_│ │ │ (_) │ │
╲_╲ ╲╱ ╲___╱│_│  │_│ │_│ │_│╲___╱╲____╱╲___╱│_│ │_│╲__│_│  ╲___╱│_│
                                                                   
```

> Автоматизированная система проверки научных работ на соответствие институциональным стандартам форматирования через глубокий анализ DOCX и интеллектуальную проверку правил.

![Status](https://img.shields.io/badge/статус-продакшн-brightgreen) ![Go](https://img.shields.io/badge/go-1.21+-00ADD8?logo=go) ![React](https://img.shields.io/badge/react-18-61DAFB?logo=react) ![License](https://img.shields.io/badge/лицензия-MIT-blue)

---

## Обзор

NormoControl - это комплексная платформа проверки документов, разработанная для образовательных учреждений с целью автоматизации оценки студенческих работ на соответствие заранее определенным стандартам форматирования. Система выполняет углубленный анализ документов Microsoft Word (.docx) без использования внешних зависимостей типа LibreOffice, полагаясь вместо этого на нативный парсинг XML для максимальной производительности и надежности.

### Ключевые Возможности

**Для Преподавателей**
- **Конструктор Стандартов**: Создание переиспользуемых шаблонов форматирования путем импорта эталонных документов или ручного определения правил
- **Автоматическое Извлечение**: Система интеллектуально извлекает поля, шрифты, интервалы и структурные элементы из образцов документов
- **Детальный Контроль**: Определение правил для типографики, макета страницы, структуры документа и ограничений содержимого
- **Панель Аналитики**: Мониторинг студенческих работ с расширенной фильтрацией, поиском и детальными отчетами о нарушениях
- **Изоляция Данных**: Полное разделение стандартов и работ между различными преподавателями

**Для Студентов**
- **Мгновенная Проверка**: Загрузка документов с немедленным получением оценки соответствия (0-100%)
- **Визуальное Картирование Ошибок**: Интерактивный просмотрщик документов с точным выделением и позиционированием ошибок
- **Детальные Отчеты**: Всеобъемлющий разбор нарушений, классифицированных по степени серьезности (критические, ошибки, предупреждения, информация)
- **История Проверок**: Доступ ко всем предыдущим проверкам с полными отчетами и оценками
- **Отзывчивый Интерфейс**: Современный, доступный UI, построенный на принципах швейцарского дизайна

---

## Архитектура

### Технологический Стек

| Уровень | Технология | Назначение |
|---------|-----------|-----------|
| **Бэкенд** | Go 1.21+ (фреймворк Gin) | Высокопроизводительный REST API с конкурентной обработкой документов |
| **Фронтенд** | React 18 (Vite) | Современное SPA с горячей перезагрузкой модулей и оптимизированными сборками |
| **Парсер Документов** | Нативный парсинг XML | Потоковый анализ DOCX без внешних зависимостей |
| **Рендеринг PDF** | pdf.js | Клиентский просмотр PDF и извлечение текста для позиционирования ошибок |
| **База Данных** | SQLite 3 | Встроенная реляционная БД с развертыванием без конфигурации |
| **Аутентификация** | JWT + HTTP-only cookies | Stateless-аутентификация с контролем доступа на основе ролей (RBAC) |
| **Развертывание** | Docker Compose | Контейнеризированные микросервисы с обратным прокси Nginx |

### Основные Компоненты

```
├── backend/
│   ├── cmd/main.go              # Точка входа приложения
│   ├── internal/
│   │   ├── checker/             # Движок проверки документов
│   │   │   ├── checker.go       # Оценка правил и подсчет баллов
│   │   │   └── parser.go        # Парсинг DOCX XML
│   │   ├── handlers/            # Обработчики HTTP-запросов
│   │   ├── middleware/          # Аутентификация, CORS, логирование
│   │   ├── models/              # Структуры данных
│   │   └── database/            # Интеграция SQLite
│   └── uploads/                 # Хранилище документов
│
├── frontend/
│   ├── src/
│   │   ├── features/            # Модули по функциям
│   │   │   ├── auth/            # Потоки аутентификации
│   │   │   ├── dashboard/       # Интерфейс студента
│   │   │   ├── teacher/         # Интерфейс преподавателя
│   │   │   └── student/         # Просмотрщик документов и отчеты
│   │   ├── components/          # Общие UI-компоненты
│   │   ├── store/               # Управление состоянием Zustand
│   │   └── api/                 # HTTP-клиент Axios
│   └── public/                  # Статические ресурсы
│
└── docker-compose.yml           # Оркестрация сервисов
```

---

## Установка и Развертывание

### Предварительные Требования

- **Docker** 20.10+ и Docker Compose (рекомендуется)
- **ИЛИ** Go 1.21+ и Node.js 18+ для локальной разработки

### Вариант 1: Развертывание через Docker (Production-Ready)

Самый простой и надежный метод развертывания с использованием контейнеризации:

```bash
# 1. Клонировать репозиторий
git clone https://github.com/Ullyminat/NormoControl.git
cd NormoControl-test

# 2. Собрать и запустить сервисы
docker-compose up --build -d

# 3. Доступ к приложению
# Фронтенд: http://localhost
# Backend API: http://localhost:8080
```

**Сервисы:**
- `academic-backend`: API-сервер Go (порт 8080)
- `academic-frontend`: Nginx с React-сборкой (порт 80)

**Постоянство Данных:**
- База данных SQLite: `./backend/normo.db`
- Загруженные документы: `./backend/uploads/`
- Конвертация PDF: `./backend/uploads/pdf/`

### Вариант 2: Локальная Разработка

Для активной разработки с горячей перезагрузкой:

**Бэкенд:**
```bash
cd backend
go mod download
go run cmd/main.go
```

**Фронтенд:**
```bash
cd frontend
npm install
npm run dev
```

Доступ по адресу `http://localhost:5173` (dev-сервер Vite с HMR)

---

## Руководство Пользователя

### Начальная Настройка

**Учетные Записи по Умолчанию:**
- **Преподаватель**: email: `teacher@example.com`, пароль: `password123`
- **Студент**: email: `student@example.com`, пароль: `password123`

### Создание Стандарта Форматирования (Workflow Преподавателя)

1. **Вход** как преподаватель
2. Перейти в **Управление Стандартами**
3. Нажать **"НОВЫЙ СТАНДАРТ"**
4. Выбрать метод создания:
   - **Импорт из Документа**: Загрузить эталонный .docx файл для автоматического извлечения правил
   - **Ручная Настройка**: Определить правила с нуля, используя форму
5. Настроить правила валидации:
   - **Поля**: Верхнее, нижнее, левое, правое (мм) с допуском
   - **Шрифт**: Название, размер для основного текста
   - **Параграф**: Междустрочный интервал, выравнивание, отступ первой строки
   - **Типографика**: Ограничения на жирный, курсив, подчеркивание, заглавные буквы
   - **Настройка Страницы**: Ориентация, расстояния колонтитулов
   - **Структура**: Иерархия заголовков, проверка оглавления
   - **Содержимое**: Запрещенные слова, ограничения количества страниц
6. **Сохранить** стандарт

### Проверка Документа (Workflow Студента)

1. **Вход** как студент
2. **Выбрать Стандарт** из доступных вариантов (использовать поиск/фильтр)
3. **Загрузить Документ** (.docx только, поддерживается drag-and-drop)
4. Система обрабатывает и отображает:
   - **Общий Балл**: Процент на основе пройденных/проваленных правил
   - **Статистика**: Всего нарушений по категориям
5. Нажать **"СМОТРЕТЬ ОТЧЕТ"** для детального анализа:
   - **Превью PDF**: Оригинальный документ с маркерами ошибок
   - **Список Нарушений**: Категоризованные ошибки с описаниями
   - **Ожидаемое vs Фактическое**: Сравнение параметров
   - **Рекомендации по Исправлению**: Контекстное руководство по корректировкам

### Просмотр Работ Студентов (Workflow Преподавателя)

1. Перейти в **Панель Статистики**
2. Использовать фильтры:
   - Поиск по имени студента
   - Фильтр по стандарту
   - Выбор диапазона дат
3. Просмотр агрегированных метрик:
   - Средние оценки
   - Графики распределения оценок
   - Наиболее частые нарушения
4. Нажать на любую работу для открытия детального отчета

---

## Движок Проверки Документов

### Процесс Оценки Правил

```
1. Загрузка DOCX → Извлечение XML
2. Парсинг Структуры Документа
   ├─ Извлечение Полей, Размера Страницы
   ├─ Парсинг Параграфов с Форматированием
   ├─ Идентификация Заголовков и Иерархии
   └─ Обнаружение Оглавлений
3. Применение Правил Стандарта
   ├─ Глобальные Проверки (поля, ориентация)
   ├─ Проверки по Параграфам (шрифт, интервалы, отступы)
   └─ Структурные Проверки (уровни заголовков, точность оглавления)
4. Расчет Оценки
   └─ оценка = (пройденные_правила / всего_правил) × 100
5. Генерация Отчета о Нарушениях
   ├─ Картирование Позиций (Страница N, Параграф M)
   └─ Классификация по Серьезности
```

### Поддерживаемые Правила Валидации

**Макет и Поля**
- Ориентация страницы (книжная/альбомная)
- Размеры полей с настраиваемым допуском
- Позиционирование верхнего и нижнего колонтитулов

**Типографика**
- Соответствие семейства и размера шрифта
- Междустрочный интервал (одинарный, 1.5, двойной)
- Выравнивание параграфа (слева, по центру, справа, по ширине)
- Отступ первой строки

**Ограничения Форматирования**
- Запрет жирного текста в основных параграфах
- Ограничения курсива и подчеркивания
- Обнаружение текста заглавными буквами

**Структура Документа**
- Валидация иерархии заголовков (H1 → H2 → H3)
- Требования разрыва страницы для заголовков верхнего уровня
- Точность номеров страниц в оглавлении

**Валидация Содержимого**
- Ограничения количества страниц документа (мин/макс)
- Проверка длины раздела "Введение"
- Обнаружение запрещенной лексики

### Расчет Оценки

Система использует алгоритм подсчета на основе правил:

```go
totalRules = количество всех применимых проверок
violations = проваленные проверки
passedRules = totalRules - violations
score = (passedRules / totalRules) × 100
```

**Ключевые Характеристики:**
- Каждая проверка параграфа вносит вклад в totalRules (шрифт, размер, интервалы и т.д.)
- Нарушения взвешены одинаково (нет множителей серьезности в базовой оценке)
- Оценка рассчитывается на стороне сервера и сохраняется в базе данных
- Фронтенд отображает оценку бэкенда единообразно во всех представлениях

---

## Справочник API

### Аутентификация

```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "secure_password",
  "full_name": "Иван Иванов",
  "role": "student"
}
```

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "secure_password"
}
```

### Управление Стандартами

```http
GET /api/standards
Authorization: Bearer <token>
```

```http
POST /api/standards/extract
Content-Type: multipart/form-data

file: <.docx файл>
```

```http
POST /api/standards
Content-Type: application/json

{
  "name": "ГОСТ 2024",
  "config_json": "{...}",
  "description": "Стандарт на основе требований ГОСТ"
}
```

### Проверка Документов

```http
POST /api/check?standard_id=1
Content-Type: multipart/form-data

file: <.docx файл>
```

**Ответ:**
```json
{
  "score": 95.5,
  "stats": {
    "total": 150,
    "failed": 7,
    "passed": 143
  },
  "violations": [
    {
      "rule_type": "margin_left",
      "description": "Неверный левый отступ",
      "severity": "error",
      "expected_value": "30.0 мм",
      "actual_value": "25.0 мм",
      "position_in_doc": "Глобально"
    }
  ],
  "content_json": "{...}"
}
```

### История и Статистика

```http
GET /api/history
Authorization: Bearer <token>
```

```http
GET /api/teacher/history
Authorization: Bearer <token>
```

---

## Безопасность и Контроль Доступа

### Авторизация на Основе Ролей

Система реализует строгий RBAC с двумя основными ролями:

**Роль Студента:**
- Доступ только к публичным стандартам
- Личная история проверок
- Загрузка и проверка документов
- Нет доступа к панелям преподавателей

**Роль Преподавателя:**
- Создание и управление стандартами
- Просмотр всех работ по своим стандартам
- Доступ к аналитике и статистике
- Нет доступа к специфичным для студентов представлениям

### Поток Аутентификации

1. Регистрация/вход пользователя → Выдается JWT
2. JWT сохраняется в HTTP-only cookie (защита от XSS)
3. Middleware валидирует токен при каждом запросе
4. Роль извлекается из claims токена
5. Применяются проверки авторизации на уровне маршрутов

### Изоляция Данных

- Стандарты фильтруются по ID пользователя `created_by`
- Студенты видят только стандарты с `public = true`
- Преподаватели просматривают работы только по своим стандартам
- Запросы к базе данных включают условия владения

---

## Разработка

### Лучшие Практики Структуры Кода

**Бэкенд (Go):**
- Паттерн Handler → Service → Repository
- Обработка ошибок с кастомными типами
- Middleware для сквозных задач
- Структурированное логирование с контекстными полями

**Фронтенд (React):**
- Структура папок на основе функций
- Zustand для управления глобальным состоянием
- Axios-перехватчики для заголовков аутентификации
- Кастомные хуки для API-взаимодействий

### Сборка для Production

**Бэкенд:**
```bash
cd backend
go build -o normocontrol cmd/main.go
./normocontrol
```

**Фронтенд:**
```bash
cd frontend
npm run build
# Вывод в директорию dist/
```

### Запуск Тестов

```bash
# Тесты бэкенда
cd backend
go test ./...

# Тесты фронтенда
cd frontend
npm run test
```

---

## Устранение Неполадок

### Частые Проблемы

**Проблема: Docker-контейнеры не запускаются**
```bash
# Проверить статус демона Docker
docker info

# Просмотреть логи контейнеров
docker-compose logs backend
docker-compose logs frontend

# Пересобрать с нуля
docker-compose down -v
docker-compose up --build
```

**Проблема: CORS ошибки в браузере**
- Убедитесь, что бэкенд работает на порту 8080
- Конфигурация прокси фронтенда в `vite.config.js` должна указывать на `http://localhost:8080`

**Проблема: Загрузка документа не работает**
- Проверьте наличие директории `uploads/` с правами на запись
- Проверьте ограничения размера файла в конфигурации Nginx
- Убедитесь, что .docx файл в валидном формате Office Open XML

**Проблема: Ошибки рендеринга PDF**
- PDF.js worker должен быть доступен по адресу `/pdf.worker.min.mjs`
- Проверьте консоль браузера на наличие 404 ошибок
- Убедитесь, что файлы из директории `public/` корректно обслуживаются

---

## Соображения Производительности

- **Конкурентная Обработка**: Горутины Go обрабатывают несколько проверок документов одновременно
- **Потоковый Парсинг**: XML-парсинг использует SAX-подобную потоковую обработку для минимизации памяти
- **Индексация БД**: Индексы на `user_id`, `standard_id`, `check_date` для быстрых запросов
- **Оптимизация Фронтенда**: Разделение кода, ленивая загрузка, мемоизированные вычисления
- **Кэширование Ресурсов**: Статические ресурсы обслуживаются с соответствующими заголовками кэша

---

## Дорожная Карта

- [ ] Поддержка дополнительных форматов документов (PDF, ODT)
- [ ] Улучшения рекомендаций на основе машинного обучения
- [ ] Пакетная обработка документов для преподавателей
- [ ] Экспорт отчетов в PDF/CSV
- [ ] Интеграция с LMS-платформами (Moodle, Canvas)
- [ ] Продвинутая проверка на плагиат
- [ ] Многоязычная поддержка (английский, русский, немецкий)

---

## Участие в Разработке

Приветствуются вклады в разработку. Пожалуйста, следуйте этим рекомендациям:

1. Форкнуть репозиторий
2. Создать ветку функции (`git checkout -b feature/amazing-feature`)
3. Коммитить изменения с описательными сообщениями
4. Запушить в свой форк
5. Открыть Pull Request с детальным описанием

**Стиль Кода:**
- Go: Следовать рекомендациям `gofmt` и `golint`
- JavaScript: Конфигурация ESLint в `.eslintrc`
- Коммиты: Использовать формат conventional commit

---
