{
    # Global options
    servers {
        trusted_proxies static 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
}

normocontrol.ddns.net {
    # 1. Grafana (Strip prefix, Grafana thinks it is at root)
    handle_path /grafana* {
        reverse_proxy academic-grafana:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # 2. Prometheus (Strip prefix)
    handle_path /prometheus* {
        reverse_proxy academic-prometheus:9090 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # 3. API (Preserve /api prefix as required by Go backend)
    handle /api* {
        request_body {
            max_size 200MB
        }
        reverse_proxy academic-backend:8090 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # 4. Frontend (Catch-all)
    handle {
        reverse_proxy academic-frontend:8080 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    log {
        output stdout
    }
}
